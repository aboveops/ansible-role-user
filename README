Роль user-func предназначена для управления функционального управления
пользователями: конфигурация пользователя будет в точности такой,
какая описана в конфиге и не имеет сайд-эффектов.

Роль написана исходя из предположения, что основная точка входа в
конфигурацию -- это не машина, а пользователь. То есть мы не хотим
создавать пользователя на машине, а вместо этого мы хотим давать
пользователю доступ к определённым машинам.

ШАБЛОН КОНФИГУРАЦИИ

- role: user-func
  username: freehck # required
  give_sudo: no
  password: "mysecret"
  lock_password: no
  disable_user: no
  delete_user: no
  shell: "/bin/bash"
  common_groups: [ "users" ]
  authorized_keys: [ key_name, ... ]
  ssh_public_keys:
    - name: freehck
      fullname: Dmitrii Kashin
      key: <public-key>
  hosts: # required
    - host: host-or-inventory-group # required
      give_sudo: yes
      password: "mysecret"
      lock_password: no
      disable_user: no
      delete_user: no
      shell: "/bin/zsh"
      groups: [ "vboxusers" ]
      authorized_keys: [ key_name, ... ]
    - host: host-or-inventory-group
      ...

Параметры делятся на глобальные и локальные. Если параметр описан
локально хосту (в словаре hosts), то берётся глобальный параметр. Если
глобальный параметр не описан, берётся значение по умолчанию.



ПАРАМЕТРЫ КОНФИГУРАЦИИ

username: обязательный параметр, определяет имя пользователя на машине

hosts: обязательный параметр, определяет список хостов, к которым
пользователь будет иметь доступ и их локальные параметры конфигурации
пользователя

give_sudo: группа sudo/wheel вынесена в отдельный параметр ввиду
исключительной важности. Данный параметр определяет, давать ли
пользователю право запуска sudo или не давать. Может быть использована
в локальной конфигурации хоста. По умолчанию no.

password: задаёт пароль пользователю. Может быть использован в
локальной конфигцрации.

lock_password: задаёт блокировку пароля. Если установлен в yes, то для
пользователя запрещён вход по паролю (в shadow ставится *). Может быть
использован локально. По умолчанию no.

disable_user: блокировка входа для пользователя. Если установлен в
yes, то вход под данным пользователем невозможен в том числе и по
ssh (дефолтный шелл устанавливается в nologin). Может быть использован
локально. По умолчанию no.

delete_user: удаление пользователя (но не его домашнего каталога).
Может быть использован локально. По умолчанию no. Использовать с
осторожностью, а лучше не использовать вообще -- disable_user более
предпочтительный вариант.

shell: задаёт шелл для пользователя. Может быть использован
локально. По умолчанию /bin/bash.

ssh_public_keys: список объектов с полями name, fullname (опционально)
и key. Представляет из себя базу со всеми известными ключами, чтобы
можно было оперировать ими по имени.

authorized_keys: список имён из базы ssh_public_keys. При этого имени
в поле name какого-либо объекта в базе, его key добавляется в
.ssh/authorized_keys. Может быть использован локально. По умолчанию [].

common_groups: исключительно глобальный параметр. Задаёт группы, общие
для всех хостов, на которых будет создан пользователь. Рекомендуется
задавать [ "users" ], по умолчанию []. Не добавляйте в него sudo. Для
этого есть give_sudo.

groups: исключительно локальный параметр. Задаёт группы, которые будут
добавлены к common_groups на этом конкретном хосте. Не добавляйте сюда
sudo. Для этого есть give_sudo.



ОСОБЕННОСТИ РАБОТЫ

При удалении пользователя не удаляет его домашний каталог. Этой
функциональности не планируется, потому что я трус и не хочу это
тестировать.

В списке хостов hosts в поле host: элементов списка можно использовать
не только имя хоста, но и группу хоста из инвентаря, а также all.

Если в списке хостов hosts какой-либо хост был сконфигурирован
несколько раз (например через группу и по имени одновременно),
пользователь не будет создан нигде, а плейбук будет остановлен с
ошибкой. Это для безопасности, чтобы не допустить произвола в
определении пользователя на машине.

При первом запуске роли группа sudo (или wheel, в зависимости от
системы) конфигурируется на беспарольный запуск от
пользователя. Парольного не предусмотрено. Повторный запуск роли не
повторит конфигурацию группы (для хоста будет установлен факт
sudo_group_configured=yes)
